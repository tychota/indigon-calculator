(function(){"use strict";function T(o){const{baseCost:s,costMultiplier:c,extraCostPercent:a,incCostPercent:M,indigonIncPercent:l,moreLessCost:x,playerManaMax:S}=o,d=M+l,i=(s*c+a*S)*(1+d/100)*x;return Math.round(i)}function F(o,s){return Math.ceil(o/s)*s}function v(o){const{server:s,player:c,skill:a,indigon:M}=o,l=s.tickInterval,x=Math.floor(s.duration/l),S=1/a.castPerSecond,d=F(S,l);let i=c.manaMax,g=[],f=d,D=!1;const p=[],k=[];let P=0,y=0;const t={time:[],spellDmg:[],manaLeft:[],manaCost:[],missedCast:[],totalSpentLast4Sec:[],castEvents:p,castDelays:k,maxSpellDmg:0,timeToMaxDmg:0,missRateAfterFirstMiss:0};for(let r=0;r<=x;r++){const e=+(r*l).toFixed(3);g=g.filter(n=>e-n.time<=4);const m=g.reduce((n,L)=>n+L.cost,0),C=Math.floor(m/200)*M.costIncPer200,u=T({baseCost:a.baseCost,costMultiplier:a.costMultiplier,extraCostPercent:a.extraCostPercent,incCostPercent:a.incCostPercent,indigonIncPercent:C,moreLessCost:a.moreLessCost,playerManaMax:c.manaMax});let h=!1;if(e>=f&&(D=!0),D)if(i>=u){const n=e;n-f>.033&&k.push({ideal:f,actual:n}),p.push({ideal:f,actual:n}),i-=u,g.push({time:e,cost:u}),f=n+d,D=!1}else h=!0;i=Math.min(c.manaMax,i+c.manaRegen*l);const I=Math.floor(m/200)*M.dmgPer200;I>P&&(P=I,y=e),t.time.push(e),t.spellDmg.push(I),t.manaLeft.push(Math.round(i)),t.manaCost.push(u),t.missedCast.push(h),t.totalSpentLast4Sec.push(m)}if(t.maxSpellDmg=P,t.timeToMaxDmg=y,p.length===0)t.missRateAfterFirstMiss=0;else{const r=p.find(e=>e.actual>e.ideal);if(!r)t.missRateAfterFirstMiss=0;else{const e=t.time[t.time.length-1],m=r.actual,C=Math.floor((e-m)/d)+1,u=p.filter(h=>h.actual>=m).length;t.missRateAfterFirstMiss=(C-u)/C*100}}return t}self.onmessage=o=>{const s=v(o.data);self.postMessage(s)}})();
